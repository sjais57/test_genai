#!/bin/bash

set -e

# Usage/help message
usage() {
cat << EOF
Usage: $(basename "$0") [OPTIONS] [VENV_NAME]

Creates a Python virtual environment in /workspace/\$USER and registers it as a Jupyter kernel.

Options:
  -h, --help        Show this help message and exit.

Arguments:
  VENV_NAME         Name of the virtual environment to create.
                    If not provided, you will be prompted.

Examples:
  $(basename "$0") myenv
  $(basename "$0")
  $(basename "$0") --help

EOF
}

# Argument parsing
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    usage
    exit 0
fi

# Set base directory
BASE_DIR="/workspace/$USER"

# Prompt or use argument for venv name
if [ -z "$1" ]; then
  read -p "Enter the name of the Python virtual environment: " VENV_NAME
  if [ -z "$VENV_NAME" ]; then
    echo "Virtual environment name cannot be empty."
    exit 1
  fi
else
  VENV_NAME="$1"
fi

VENV_PATH="$BASE_DIR/$VENV_NAME"

# Create base directory if it doesn't exist
mkdir -p "$BASE_DIR"

# Check if virtual environment already exists
if [ -d "$VENV_PATH" ]; then
  echo "Virtual environment '$VENV_NAME' already exists at $VENV_PATH"
  exit 1
fi

# Create virtual environment
if ! python3 -m venv "$VENV_PATH"; then
  echo "Failed to create virtual environment."
  exit 1
fi

echo "Virtual environment created at: $VENV_PATH"

# Activate the virtual environment
# shellcheck source=/dev/null
source "$VENV_PATH/bin/activate"

# Upgrade pip and install ipykernel
echo "Installing pip and ipykernel..."
pip install --upgrade pip >/dev/null
pip install ipykernel >/dev/null

# Add Jupyter kernel with same name
if python -m ipykernel install --user --name="$VENV_NAME" --display-name="Python ($VENV_NAME)" >/dev/null; then
  echo "Kernel 'Python ($VENV_NAME)' added successfully."
else
  echo "Failed to create Jupyter kernel."
  deactivate
  exit 1
fi

# Deactivate virtual environment
deactivate

echo
echo "To activate this environment manually later, run:"
echo "   source \"$VENV_PATH/bin/activate\""
